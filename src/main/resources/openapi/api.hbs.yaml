openapi: 3.0.1

# ThorAPI Enhanced Sections
info:
externalDocs:
servers:
tags:
paths:

components:
  parameters:
    id:
      name: id
      in: path
      required: true
      description: The unique identifier of the object to retrieve.
      schema:
        type: string
        format: uuid

  schemas:


    ## SecureField KMS - the ultimate encryption solution
    SecureKey:
      type: object
      description: SecureKey is the KMS for the SecureField keys 
      x-valkyrai-service: microservice
      properties:
        notes:
          description: any notes about the key
          type: string
          maxLength: 1000
          example: "This key was generated by the system"

        algorithm:
          description: the algorithm used for encryption/decryption
          type: string

        version:
          description: the version of this key
          type: string

        keyHash:
          description: the searchable hash of the key itself
          type: string
          minLength: 10
          maxLength: 100

        cipherWorkCost:
          description: the exponential strength of the BCrypt hashing used by the Hashing cipher
          example: 12
          type: integer
          minimum: 10
          maximum: 35
        
        keyValue:
          description: the key itself
          type: string
          minLength: 10
         # x-thorapi-secureField: true

        status:
          type: string
          enum:
            - ACTIVE
            - DEFAULT            
            - ARCHIVED
            - REVOKED
            - INVALID
          x-enum-descriptions:
            - Key is actively used
            - Key is the default to use when no specif key is provided
            - Key is not being used but still valid
            - Key is revoked and MUST NOT be used
            - Key is invalid and will not work
          x-enum-varnames:
            - keyActive
            - keyDefault
            - keyArchived
            - keyRevoked
            - keyInvalid
      required:
        - algorithm
        - version
        - keyValue
        - status

    EventLog:
      type: object
      description: Logs specific Workflow Related Events 
      properties:
        eventDetails:
          type: string
          description: detailed event description
        status:
          type: string
          enum: [ok, error, disabled]
          description: status for event
      xml:
        name: EventLog


    Principal:
      required:
        - email
        - password
        - username
      type: object
      description: The Valkyr Principal. Represents a user, service, or agent in the system with preferences and privileges.
      properties:
        firstName:
          type: string
          description: first name of user (encrypted)
          example: Peace
          x-thorapi-dataField: fieldGroup=personal-details
          x-thorapi-secureField: true

        middleName:
          type: string
          description: middle name of user
          example: Love
          x-thorapi-dataField: fieldGroup=personal-details
          x-thorapi-secureField: true          

        lastName:
          type: string
          description: last name of user (encrypted)
          example: Harmony
          x-thorapi-secureField: true

        username:
          maxLength: 60
          minLength: 5
          type: string
          description: Your account user name
          example: Sparky
          x-thorapi-dataField: fieldGroup=personal-details, unique=true
        
        password:
          minLength: 8
          type: string
          description: Your account password
          format: password
          writeOnly: true
          example: HardToGuess1980  
          x-field-extra-annotation:
            "@SecureField(encryptionType = SecureField.EncryptionType.HASHED, strength = 10)"

        fingerprint:
          type: string
          description: Encrypted identity (Facial Recognition, Fingerprint Scanner,
            etc.)
          readOnly: true
          example: DK$DFSJaraDD
          x-thorapi-dataField: advanced=true
          x-thorapi-secureField: true

        federalIdentification:
          pattern: ^\d{3}-\d{2}-\d{4}$
          default: 333-22-4444
          type: string
          description: SSN or a 10 digit federal government ID (encrypted)
          example: "111-22-3333"
          x-thorapi-secureField: true

        residenceCountry:
          minLength: 3

          type: string
          description: Country of residence 3-character code
          example: USA
          x-thorapi-dataField: advanced=true
          x-thorapi-secureField: true

        stateIdentification:
          minLength: 10
          # maxLength: 10
          pattern: ^\d{10}$
          type: string
          description: Driver's License or a 10 digit state government ID
          example: 3333333333
          default: 2222222222
          x-thorapi-dataField: advanced=true
          x-thorapi-secureField: true

        residenceState:
          minLength: 2
          # maxLength: 2
          type: string
          description: State of residence 2-character code (USA)
          example: CA
          x-thorapi-dataField: advanced=true
          x-thorapi-secureField: true

        email:
          pattern: ^[a-zA-Z0-9_!#$%&â€™*+/=?`{|}~^.-]+@[a-zA-Z0-9.-]+$
          type: string
          description: The main email address for the user (encrypted)
          format: email
          example: wiley.coyote@acme-corp.com
          x-thorapi-dataField: unique=true
          # x-thorapi-secureField: true

        social:
          type: string
          description: The username for your primary social account (if any)
          format: url
          example: https://twitter.com/ValkyrAI
          x-thorapi-secureField: true

        bio:
          type: string
          description: More in-depth information about you and your account
          maxLength: 100000

        notes:
          type: string
          example: Notes about this account
          maxLength: 100000

        avatarUrl:
          type: string
          description: URL for the user avatar image
          format: url
          example: https://img.com/mypic.png
        
        # for now one per user

        acceptedCookies:
          type: boolean
          description: Whether the user accepted the use of cookies
          default: true
          x-thorapi-dataField: advanced=true, fieldGroup=signup

        acceptedTos:
          type: boolean
          description: Whether the user accepted the terms of service
          default: true
          x-thorapi-dataField: advanced=true, fieldGroup=signup

        # Spring Security section
        enabled:
          type: boolean
          description: Spring Security User field whether the user is enabled
          default: true
          x-thorapi-dataField: advanced=true, fieldGroup=accountStatus
        credentialNonExpired:
          type: boolean
          description: Spring Security User field whether the user's login credentials
            have expired
          default: true
          x-thorapi-dataField: advanced=true, fieldGroup=accountStatus
        accountEnabled:
          type: boolean
          description: Spring Security User field whether the user account is enabled
          default: true
          x-thorapi-dataField: advanced=true, fieldGroup=accountStatus
        accountNonLocked:
          type: boolean
          description: Spring Security User field whether the user account is locked
          default: true
          x-thorapi-dataField: advanced=true, fieldGroup=accountStatus
        accountNonExpired:
          type: boolean
          description: Spring Security User field whether the user account has expired
          default: false
          x-thorapi-dataField: advanced=true, fieldGroup=accountStatus

        roleList:
          description: the roles the the Principal is a member of
          type: array
          items:
            $ref: '#/components/schemas/Role'

        authorityList:
          x-thorapi-dataField: advanced=true, fieldGroup=accountStatus
          description: the granted authorities (or null if the granted authority cannot be expressed as a String with sufficient precision).
          type: array
          items:
            $ref: '#/components/schemas/Authority'

      xml:
        name: Principal    
      
    UserPreference:
      type: object
      description: Various System User Preferences
      properties:
        principalId:
          type: string
          format: uuid
        preference:
          type: string
          description: The value of the User Preferences
          example: "darquartz"
        preferenceType:
          type: string
          description: The type of the preference
          enum:
            - ux-layout
            - ux-mode
            - ux-theme
            - measurement
    
    ## Spring Security section
    Login:
      type: object
      description: TODO Login CLASS DESCRIPTION
      properties:
        username:
          type: string
          maxLength: 64
        password:
          type: string
          x-starter-secureField: true
        token:
          type: string
          x-starter-secureField: true
        authenticatedPrincipalId:
          type: string
          format: uuid
          deprecated: true
          description: Deprecated; use authenticatedPrincipal
        authenticatedPrincipal:
          $ref: '#/components/schemas/Principal'
        description:
          type: string
      
    Logout:
      type: object
      description: Logout functionality
      properties:
        description:
          type: string
          
    PersistentLogin:
      type: object
      description: Persistent Login for Spring Security
      properties:
        username:
          type: string
          maxLength: 64
        series:
          type: string
          maxLength: 64
        token:
          type: string
          maxLength: 64
        lastUsed:
          type: string
          format: date-time
      required:
        - username
        - series
        - token
        - last_used

    Role:
      type: object
      description: A Role for a Principal in the system
      properties:
        principalId:
          type: string
          format: uuid
        roleName:
          type: string
          description: the role
          enum: [EVERYONE, STAFF, ADMIN]
          x-enum-descriptions:
            - All Authenticated Users
            - Staff Role
            - Admin Role
          x-enum-varnames:
            - ROLE_EVERYONE
            - ROLE_STAFF
            - ROLE_ADMIN
          default: EVERYONE

    Authority:
      type: object
      description: Simple GrantedAuthority mapping for a user
      properties:
        principalId:
          type: string
          format: uuid
        username:
          type: string
          maxLength: 50
        authority:
          type: string
          maxLength: 50
      required: [username, authority]

    AclSid:
      type: object
      description: >
        Security IDentity (SID). One row per unique principal (username) or GrantedAuthority.
      properties:
        id:
          type: integer
          format: int64
          description: Database identifier (matches Spring ACL default BIGINT)
        sid:
          type: string
          maxLength: 245
          description: Username or authority name (e.g., 'anonymousUser' or 'ROLE_ADMIN' or a UUID as a string)
        principal:
          type: boolean
          description: true if SID refers to a principal (username), false if it refers to a GrantedAuthority
      required: [sid, principal]

    AclClass:
      type: object
      description: Maps a Java class name to an internal ID for ACL usage.
      properties:
        id:
          type: integer
          format: int64
        _class:
          type: string
          nullable: false
          x-field-extra-annotation: "@Column(name = \"class\")"
      required: [_class]

    AclObjectIdentity:
      type: object
      description: One row per secured domain object instance.
      properties:
        id:
          type: integer
          format: int64
        objectIdClass:
          $ref: '#/components/schemas/AclClass'
          description: Class of the secured object
        objectIdIdentity:
          type: string
          format: uuid
          description: UUID of the specific secured object instance
        parentObject:
          $ref: '#/components/schemas/AclObjectIdentity'
          description: Optional parent for hierarchical permissions
          nullable: true
        ownerSid:
          $ref: '#/components/schemas/AclSid'
          description: Owner SID for this object
        entriesInheriting:
          type: boolean
          description: If true, entries inherit from parent ACL
        aclEntries:
          type: array
          items:
            $ref: '#/components/schemas/AclEntry'
          description: ACL entries that define permissions for this object

        # ---- Backward-compat fields (deprecated) ----
        parentObjectId:
          type: string
          format: uuid
          nullable: true
          deprecated: true
          description: Deprecated; use parentObject
        ownerSid:
          type: string
          format: uuid
          deprecated: true
          description: Deprecated; use owner
        aclClassId:
          type: string
          format: uuid
          deprecated: true
          description: Deprecated; use objectIdClass
      required: [objectIdClass, objectIdIdentity, entriesInheriting]

    AclEntry:
      type: object
      description: Individual permission assignment for a recipient (AclSid) on an object.
      properties:
        id:
          type: integer
          format: int64
        aclObjectIdentity:
          $ref: '#/components/schemas/AclObjectIdentity'
          description: The secured object
        aceOrder:
          type: integer
          format: int32
          description: Ordering within the ACL
        aclSid:
          $ref: '#/components/schemas/AclSid'
          description: Recipient SID (principal or authority)
        mask:
          type: integer
          format: int32
          description: Bit mask representing the granted/denied permission(s)
        granting:
          type: boolean
          description: true if this is a granting entry, false if denying
        auditSuccess:
          type: boolean
          description: Audit on successful authorization
        auditFailure:
          type: boolean
          description: Audit on failed authorization

        # ---- Backward-compat fields (deprecated) ----
        aclObjectIdentityIdXX:
          type: string
          format: uuid
          deprecated: true
          description: Deprecated; use aclObjectIdentity
        sid:
          type: string
          format: uuid
          deprecated: true
          description: Deprecated; use aclSid
      required: [aclObjectIdentity, aceOrder, aclSid, mask, granting]

  securitySchemes:
    thorapi_auth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    thorapi_oauth:
      type: oauth2
      flows:
        implicit:
          authorizationUrl: https://{username}.valkyrlabs.com:{port}/oauth
          scopes:
            write:items: modify owned items
            read:items: read owned items
